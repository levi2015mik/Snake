<!DOCTYPE html>
<html>
<head>
	<title>Snake</title>
	<style type="text/css">
		.field{
			border:dotted 3px #cccccc;
			width: 400px;
			line-height: 0;
		}
		.exel{
			width: 20px;
			height: 20px;
			box-sizing: border-box;
			border: solid 1px #000;
			display: inline-block;
		}
		.exel.snake{
			background-color: green;
		}

		.exel.mouse{
			background-color: gray;
		}

	</style>
</head>
<body>
	<div class="field"></div>
	<button class="gameBtn">Start / Pause</button><span class="gameGoal"></span>

</body>
<script type="text/javascript">
	const EMPTY = 0
	const TAIL  = 1
	const HEAD  = 2
	const MOUSE = 3
	const WALL  = 4

	class Exel{
		constructor(x,y){
			this.element = document.createElement("div")
			this.element.className = "exel"
			this.x = x;
			this.y = y;
			this._state = EMPTY;
			this.turn = 0
			this.modX = 1
			this.modY = 0
		}
		set state(state){			
			this._state = state;
			switch(state){
				case EMPTY: this.element.classList.remove("snake","mouse"); break;
				case TAIL: this.element.classList.add("snake");break;
				case HEAD: this.element.classList.add("snake"); break;
				case MOUSE:this.element.classList.add("mouse"); break;
				case WALL: break;
			}	
		}

		get state(){
			return this._state
		}
	}

	class Snake{
		constructor(len){
			this.x = getRandomArbitrary(len,19)
			this.y = getRandomArbitrary(0,19)
			this.len = len;
			this.modX = 1;
			this.modY = 0;
			this.elements = []
			let ceils = 0
			while(len){
				len --;
				let x = this.x - ceils
				this.elements.push(Exel.matrix[this.y][x])
				this.elements[ceils].state = TAIL
				ceils ++
			}
			this.elements[0].state = HEAD
		}

		step(){
			for (var i = 0; i < this.elements.length; i++) {

				if(this.elements[i].turn === 1){
					if(this.elements[i].modX === 1 && this.elements[i].modY === 0){
						this.elements[i].modX = 0
						this.elements[i].modY = 1
					} else
					if(this.elements[i].modX === 0 && this.elements[i].modY === 1){
						this.elements[i].modX = -1
						this.elements[i].modY = 0

					} else
					if(this.elements[i].modX === -1 && this.elements[i].modY === 0){
						this.elements[i].modX = 0
						this.elements[i].modY = -1

					} else
					if(this.elements[i].modX === 0 && this.elements[i].modY === -1){
						this.elements[i].modX = 1
						this.elements[i].modY = 0

					}

				}
				if(this.elements[i].turn === -1){
					if(this.elements[i].modX === 1 && this.elements[i].modY === 0){
						this.elements[i].modX = 0
						this.elements[i].modY = -1
					} else
					if(this.elements[i].modX === 0 && this.elements[i].modY === -1){
						this.elements[i].modX = -1
						this.elements[i].modY = 0
					} else
					if(this.elements[i].modX === -1 && this.elements[i].modY === 0){
						this.elements[i].modX = 0
						this.elements[i].modY = 1
					} else
					if(this.elements[i].modX === 0 && this.elements[i].modY === 1){
						this.elements[i].modX = 1
						this.elements[i].modY = 0
					}

				}

				let modX = this.elements[i].modX;
				let modY = this.elements[i].modY;


				if(i === 0){
					this.x += this.elements[i].modX;
					if(this.x > 19) this.x = 0
					if(this.x < 0 ) this.x = 19
					this.y += this.elements[i].modY;
					if(this.y > 19) this.y = 0
					if(this.y < 0 ) this.y = 19
					this.colisionTest(this.x,this.y)
					//this.onStep(this.x,this.y)
				}

				let x = this.elements[i].x + modX
				if(x > 19) x = 0
				if(x < 0 ) x = 19

				let y = this.elements[i].y + modY
				if(y > 19) y = 0
				if(y < 0 ) y = 19

				this.elements[i].state = EMPTY
				if(i === this.elements.length -1) this.elements[i].turn = 0;
				this.elements[i] = Exel.matrix[y][x]
				this.elements[i].modX = modX;
				this.elements[i].modY = modY;
				this.elements[i].state = i === 0? HEAD: TAIL; 
			}
			this.onStep(this.x,this.y)
		}

		push(){
			debugger;
			this.x += this.elements[0].modX;
			if(this.x > 19) this.x = 0
			if(this.x < 0 ) this.x = 19
			this.y += this.elements[0].modY;
			if(this.y > 19) this.y = 0
			if(this.y < 0 ) this.y = 19
			this.colisionTest(this.x,this.y)
			this.elements.unshift(Exel.matrix[this.y][this.x])
			this.elements[0].state = HEAD;
			
			//this.onStep(this.x,this.y)
		}
		colisionTest(x,y){
			for (var i = 0; i < this.elements.length; i++) {
				if(this.elements[i].x === x && this.elements[i].y === y) this.onAutoCollesion();
			}
		}
	}


	Exel.createField = function createField(width,height,el){
		Exel.matrix = []
		el.innerHTML = ""
		let count = width * height
		for (var i = 0; i < count; i++) {
			let x = i % width
			let y = parseInt(i/width)
			let exel = new Exel(x,y)
			el.appendChild(exel.element)
			if(!Exel.matrix[y])Exel.matrix[y] = [];
			Exel.matrix[y][x] = exel;
		}
	}

	class Mouse {
		// Создание мыши в случайной точке, кроме списка запрещенных точек. 
		constructor(map,matrix){
			let x,y=0
			while(!map[y][x]){
				x = getRandomArbitrary(0,map[y].length);
				y = getRandomArbitrary(0,map.length)
			}
			this.matrix = matrix
			this.matrix[y][x].state = MOUSE;
			this.x = x
			this.y = y
		}

		del(){
			this.matrix[this.y][this.x].state = EMPTY;
		}
	}


	class Game {
		constructor(){}
		start(interval) {
			this.interval = interval? interval: 500; 
			Exel.createField(20,20,document.querySelector(".field"))
			this.snake = new Snake(3);
			
			this.snake.onAutoCollesion = this.restart.bind(this)
			this.snake.onStep = this.stepTest.bind(this)

			this.createMap();

			this.int = setInterval(()=>this.snake.step(),this.interval)
			document.addEventListener("keydown",(e)=>{
				if(e.keyCode === 37) this.snake.elements[0].turn = -1
				if(e.keyCode === 39) this.snake.elements[0].turn = 1
			})
		}
		stop(){
			clearInterval(this.int)
		}
		rePause(){
			this.int = setInterval(()=>this.snake.step(),this.interval)
		}
		restart(){
			this.stop();
			alert("You are lost!")
			this.goal = 0;
			setTimeout(()=>this.start(),2000)
			
		}
		/**
		* Проверка шага по карте Решения - snake.push + this.updateMap / this.restart
		*/
		stepTest(x,y){
			if(x === this.mouse.x && y === this.mouse.y){
				this.snake.push()
				this.updateMap()
				this.goal = this.goal +1
			}
		}

		set goal(goal){
			this._goal = goal;
			document.querySelector(".gameGoal").innerHTML = this.goal;
		}
		get goal(){
			return this._goal | 0;
		} 
		createMap(){

			this.updateMap()	
		}
		updateMap(){
			if(this.mouse) this.mouse.del()
			this.mouse = new Mouse(mapField(Exel.matrix),Exel.matrix)
		}
	}

	function getRandomArbitrary(min, max) {
  		return Math.round(Math.random() * (max - min) + min);
	}

	function mapField(field) {
		let out = [];
		for (var i = 0; i < field.length; i++) {
			out[i] = field[i].map(el=>el.state === EMPTY)
		}
		return out
	}

	var game = new Game()
	game.start()

</script>
</html>